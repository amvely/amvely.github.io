<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meta Ads Report</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #f5f6fa;
      --surface: #ffffff;
      --surface2: #f8f9fc;
      --surface3: #eef0f6;
      --border: #e4e7f0;
      --border2: #d0d4e2;
      --brand: #1a56db;
      --brand-light: #eff4ff;
      --brand-mid: #c7d7fc;
      --green: #0e9f6e;
      --green-light: #e8f7f0;
      --red: #e02424;
      --red-light: #fdf2f2;
      --yellow: #c27803;
      --yellow-light: #fdf6e3;
      --purple: #7e3af2;
      --purple-light: #f3eeff;
      --text: #111827;
      --text2: #4b5563;
      --text3: #9ca3af;
      --font: 'Plus Jakarta Sans', sans-serif;
      --mono: 'JetBrains Mono', monospace;
      --radius: 14px;
      --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 24px rgba(0,0,0,0.08);
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--text); font-family: var(--font); min-height: 100vh; }

    /* HEADER */
    header {
      background: var(--surface); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 40px; height: 64px; position: sticky; top: 0; z-index: 50;
    }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo-icon { width: 32px; height: 32px; background: var(--brand); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 16px; }
    .logo-text { font-size: 16px; font-weight: 800; color: var(--text); letter-spacing: -0.3px; }
    .logo-text span { color: var(--brand); }
    .header-right { display: flex; align-items: center; gap: 10px; }
    #last-updated { font-family: var(--mono); font-size: 11px; color: var(--text3); }
    .btn-sm { background: var(--surface2); border: 1px solid var(--border); color: var(--text2); padding: 7px 14px; border-radius: 8px; font-family: var(--font); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 6px; }
    .btn-sm:hover { background: var(--brand-light); border-color: var(--brand-mid); color: var(--brand); }
    .btn-sm svg { width: 13px; height: 13px; }

    /* LOADING */
    #loading { display: none; position: fixed; inset: 0; background: rgba(245,246,250,0.9); z-index: 100; align-items: center; justify-content: center; flex-direction: column; gap: 14px; }
    #loading.active { display: flex; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--border2); border-top-color: var(--brand); border-radius: 50%; animation: spin 0.75s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loading p { font-size: 13px; color: var(--text2); font-family: var(--mono); }

    /* SETUP */
    #setup-panel { max-width: 680px; margin: 52px auto; padding: 0 20px; }
    .setup-card { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 44px; box-shadow: var(--shadow); }
    .setup-eyebrow { font-family: var(--mono); font-size: 11px; letter-spacing: 2px; text-transform: uppercase; color: var(--brand); margin-bottom: 10px; }
    .setup-title { font-size: 26px; font-weight: 800; color: var(--text); margin-bottom: 8px; letter-spacing: -0.5px; }
    .setup-desc { color: var(--text2); font-size: 14px; line-height: 1.65; margin-bottom: 32px; }
    .setup-desc a { color: var(--brand); text-decoration: none; font-weight: 600; }
    .setup-desc a:hover { text-decoration: underline; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 14px; }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 12px; font-weight: 700; color: var(--text2); }
    .form-group input, .form-group select { background: var(--surface2); border: 1.5px solid var(--border); color: var(--text); padding: 10px 14px; border-radius: 10px; font-family: var(--mono); font-size: 13px; outline: none; transition: border-color 0.15s, box-shadow 0.15s; }
    .form-group input:focus, .form-group select:focus { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(26,86,219,0.1); background: #fff; }
    .btn-connect { width: 100%; padding: 14px; background: var(--brand); border: none; border-radius: 10px; color: #fff; font-family: var(--font); font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.15s; margin-top: 6px; }
    .btn-connect:hover { background: #1648c4; box-shadow: 0 4px 16px rgba(26,86,219,0.3); }
    .error-msg { display: none; margin-top: 14px; padding: 12px 16px; background: var(--red-light); border: 1px solid #fbd5d5; border-radius: 10px; color: var(--red); font-size: 13px; font-family: var(--mono); }
    .hint-box { margin-top: 22px; padding: 16px 18px; background: var(--brand-light); border: 1px solid var(--brand-mid); border-radius: 10px; }
    .hint-box p { font-size: 12.5px; color: var(--text2); line-height: 1.65; }
    .hint-box strong { color: var(--brand); font-weight: 700; }

    /* DASHBOARD */
    #dashboard { display: none; padding: 28px 40px 60px; }
    .controls-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
    .page-title { font-size: 20px; font-weight: 800; letter-spacing: -0.3px; color: var(--text); }
    .page-sub { font-size: 13px; color: var(--text3); margin-top: 2px; }
    .controls-right { display: flex; align-items: center; gap: 8px; }
    .status-dot { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text2); font-weight: 600; }
    .dot-live { width: 7px; height: 7px; background: var(--green); border-radius: 50%; box-shadow: 0 0 6px var(--green); animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.4} }
    .date-select { background: var(--surface); border: 1.5px solid var(--border); color: var(--text); padding: 7px 12px; border-radius: 8px; font-family: var(--font); font-size: 13px; font-weight: 600; cursor: pointer; outline: none; }

    /* SECTION */
    .section-label { font-size: 11px; font-weight: 700; color: var(--text3); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 10px; padding-left: 2px; }
    .section-block { margin-bottom: 22px; }

    /* KPI GRID */
    .kpi-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin-bottom: 12px; }
    @media(max-width:900px){ .kpi-grid { grid-template-columns: repeat(2,1fr); } }
    .kpi-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px 22px; box-shadow: var(--shadow); transition: transform 0.15s, box-shadow 0.15s; }
    .kpi-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .kpi-top { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 12px; }
    .kpi-label { font-size: 11px; font-weight: 700; color: var(--text3); letter-spacing: 0.3px; text-transform: uppercase; }
    .kpi-ico { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 15px; }
    .kpi-val { font-size: 26px; font-weight: 800; color: var(--text); letter-spacing: -0.8px; line-height: 1; margin-bottom: 6px; }
    .kpi-meta { display: flex; align-items: center; justify-content: space-between; gap: 6px; }
    .kpi-sub { font-family: var(--mono); font-size: 11px; color: var(--text3); }
    .kpi-tag { display: inline-flex; align-items: center; padding: 2px 7px; border-radius: 100px; font-family: var(--mono); font-size: 10px; font-weight: 600; }
    .tag-blue { background: var(--brand-light); color: var(--brand); }
    .tag-green { background: var(--green-light); color: var(--green); }
    .tag-red { background: var(--red-light); color: var(--red); }
    .tag-gray { background: var(--surface3); color: var(--text3); }

    /* ROAS + CPM row */
    .wide-kpi-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .wide-kpi { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px 22px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 16px; }
    .wide-ico { width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; }
    .wide-content { flex: 1; }
    .wide-label { font-size: 11px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 4px; }
    .wide-val { font-size: 30px; font-weight: 800; letter-spacing: -1px; color: var(--text); line-height: 1; margin-bottom: 4px; }
    .wide-sub { font-family: var(--mono); font-size: 11px; color: var(--text3); }
    .roas-bar-wrap { height: 3px; background: var(--border); border-radius: 99px; overflow: hidden; margin-top: 8px; }
    .roas-bar { height: 100%; background: linear-gradient(90deg, var(--brand), var(--purple)); border-radius: 99px; transition: width 0.8s ease; }

    /* CHARTS */
    .chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 22px 24px; box-shadow: var(--shadow); }
    .card-title { font-size: 13px; font-weight: 800; color: var(--text); margin-bottom: 2px; }
    .card-sub { font-size: 11px; color: var(--text3); margin-bottom: 16px; }
    .charts-row { display: grid; grid-template-columns: 7fr 3fr; gap: 12px; margin-bottom: 12px; }
    @media(max-width:900px){ .charts-row { grid-template-columns: 1fr; } }
    .charts-row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    @media(max-width:900px){ .charts-row3 { grid-template-columns: 1fr; } }

    /* TREND TABS */
    .tab-row { display: flex; gap: 3px; margin-bottom: 14px; }
    .tab-btn { padding: 5px 11px; border-radius: 7px; border: 1px solid transparent; font-family: var(--font); font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.15s; background: transparent; color: var(--text3); }
    .tab-btn.active { background: var(--brand-light); border-color: var(--brand-mid); color: var(--brand); }
    .tab-btn:hover:not(.active) { background: var(--surface3); color: var(--text2); }

    /* DONUT LEGEND */
    .legend-list { display: flex; flex-direction: column; gap: 8px; margin-top: 16px; }
    .legend-row { display: flex; align-items: center; gap: 7px; }
    .legend-color { width: 9px; height: 9px; border-radius: 3px; flex-shrink: 0; }
    .legend-name { font-size: 12px; color: var(--text2); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .legend-amt { font-family: var(--mono); font-size: 11px; color: var(--text3); }
    .legend-pct { font-family: var(--mono); font-size: 11px; color: var(--text); font-weight: 600; min-width: 30px; text-align: right; }

    /* TABLE */
    .table-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
    .table-header { display: flex; align-items: center; justify-content: space-between; padding: 18px 22px 14px; border-bottom: 1px solid var(--border); }
    .table-scroll { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead tr { background: var(--surface2); }
    thead th { font-size: 10px; font-weight: 700; color: var(--text3); letter-spacing: 0.5px; text-transform: uppercase; padding: 9px 14px; text-align: left; white-space: nowrap; border-bottom: 1px solid var(--border); }
    thead th.r { text-align: right; }
    tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: var(--surface2); }
    tbody td { padding: 12px 14px; font-size: 13px; color: var(--text); vertical-align: middle; }
    .td-r { text-align: right; font-family: var(--mono); font-size: 12px; color: var(--text2); }
    .td-rh { text-align: right; font-family: var(--mono); font-size: 12px; color: var(--text); font-weight: 600; }
    .c-name { font-weight: 700; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .c-obj { font-size: 11px; color: var(--text3); margin-top: 1px; }
    .s-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 9px; border-radius: 100px; font-size: 11px; font-weight: 700; }
    .s-active { background: var(--green-light); color: var(--green); }
    .s-paused { background: var(--yellow-light); color: var(--yellow); }
    .s-other { background: var(--surface3); color: var(--text3); }
    .roas-pill { display: inline-block; padding: 3px 8px; border-radius: 6px; font-family: var(--mono); font-size: 11px; font-weight: 600; }
    .rg { background: var(--green-light); color: var(--green); }
    .rb { background: var(--brand-light); color: var(--brand); }
    .rl { background: var(--red-light); color: var(--red); }
    .bar-wrap { height: 3px; background: var(--border); border-radius: 99px; overflow: hidden; margin-top: 3px; min-width: 60px; }
    .bar-fill { height: 100%; background: var(--brand); border-radius: 99px; }
    .empty-state { padding: 48px; text-align: center; color: var(--text3); font-size: 14px; }

    /* TOAST */
    #toast { position: fixed; bottom: 28px; right: 28px; background: var(--text); color: #fff; border-radius: 10px; padding: 12px 18px; font-size: 13px; font-weight: 600; z-index: 999; transform: translateY(80px); opacity: 0; transition: all 0.25s; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
    #toast.show { transform: translateY(0); opacity: 1; }
  </style>
</head>
<body>

<div id="loading"><div class="spinner"></div><p>Meta APIì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>
<div id="toast"></div>

<header>
  <div class="logo">
    <div class="logo-icon">ğŸ“Š</div>
    <div class="logo-text">Meta <span>Ads</span> Report</div>
  </div>
  <div class="header-right">
    <span id="last-updated"></span>
    <button class="btn-sm" id="refresh-btn" style="display:none" onclick="refreshData()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
      ìƒˆë¡œê³ ì¹¨
    </button>
    <button class="btn-sm" id="export-btn" style="display:none" onclick="exportCSV()">â¬‡ CSV</button>
    <button class="btn-sm" id="logout-btn" style="display:none" onclick="logout()">ì—°ê²° í•´ì œ</button>
  </div>
</header>

<!-- SETUP -->
<div id="setup-panel">
  <div class="setup-card">
    <div class="setup-eyebrow">Meta Business API</div>
    <div class="setup-title">ê´‘ê³  ì„±ê³¼ ë¦¬í¬íŠ¸ ì—°ê²°</div>
    <div class="setup-desc">
      <a href="https://developers.facebook.com/tools/explorer/" target="_blank">Graph API Explorer</a>ì—ì„œ ë°œê¸‰í•œ
      ì•¡ì„¸ìŠ¤ í† í°ê³¼ ê´‘ê³  ê³„ì • IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br/>
      í† í°ì— <strong>ads_read</strong>, <strong>read_insights</strong> ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.
    </div>
    <div class="form-grid">
      <div class="form-group" style="grid-column:1/-1">
        <label>ì•¡ì„¸ìŠ¤ í† í° (Access Token)</label>
        <input type="password" id="access-token" placeholder="EAAxxxxxxxxxxxxx..." autocomplete="off" />
      </div>
      <div class="form-group">
        <label>ê´‘ê³  ê³„ì • ID</label>
        <input type="text" id="account-id" placeholder="act_123456789" />
      </div>
      <div class="form-group">
        <label>ì¡°íšŒ ê¸°ê°„</label>
        <select id="date-preset">
          <option value="last_7d">ìµœê·¼ 7ì¼</option>
          <option value="last_14d">ìµœê·¼ 14ì¼</option>
          <option value="last_30d" selected>ìµœê·¼ 30ì¼</option>
          <option value="last_90d">ìµœê·¼ 90ì¼</option>
          <option value="this_month">ì´ë²ˆ ë‹¬</option>
          <option value="last_month">ì§€ë‚œ ë‹¬</option>
        </select>
      </div>
    </div>
    <button class="btn-connect" onclick="connectAPI()">ë°ì´í„° ì—°ê²°í•˜ê¸° â†’</button>
    <div class="error-msg" id="error-msg"></div>
    <div class="hint-box">
      <p>
        ğŸ’¡ <strong>í† í° ë°œê¸‰:</strong> Meta for Developers â†’ Graph API Explorer â†’ Generate Access Token (ê¶Œí•œ: ads_read, read_insights)<br/>
        ğŸ’¡ <strong>ê³„ì • ID:</strong> ë¹„ì¦ˆë‹ˆìŠ¤ ê´€ë¦¬ìì—ì„œ í™•ì¸, ìˆ«ì ì•ì— <strong>act_</strong> ìë™ìœ¼ë¡œ ë¶™ì—¬ë“œë¦½ë‹ˆë‹¤.<br/>
        ğŸ”’ ëª¨ë“  ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì € ë‚´ì—ì„œë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤. GitHub Pagesì— ì˜¬ë¦¬ë©´ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
      </p>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
  <div class="controls-bar">
    <div>
      <div class="page-title">ê´‘ê³  ì„±ê³¼ ë¦¬í¬íŠ¸</div>
      <div class="page-sub" id="date-range-label">â€”</div>
    </div>
    <div class="controls-right">
      <div class="status-dot"><div class="dot-live"></div><span id="account-label">ì—°ê²°ë¨</span></div>
      <select class="date-select" id="dash-date-preset" onchange="refreshData()">
        <option value="last_7d">ìµœê·¼ 7ì¼</option>
        <option value="last_14d">ìµœê·¼ 14ì¼</option>
        <option value="last_30d" selected>ìµœê·¼ 30ì¼</option>
        <option value="last_90d">ìµœê·¼ 90ì¼</option>
        <option value="this_month">ì´ë²ˆ ë‹¬</option>
        <option value="last_month">ì§€ë‚œ ë‹¬</option>
      </select>
    </div>
  </div>

  <!-- KPIs -->
  <div class="section-block">
    <div class="section-label">í•µì‹¬ ì§€í‘œ</div>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-top"><div class="kpi-label">ë…¸ì¶œìˆ˜</div><div class="kpi-ico" style="background:var(--brand-light);color:var(--brand)">ğŸ‘</div></div>
        <div class="kpi-val" id="kpi-impressions">â€”</div>
        <div class="kpi-meta"><div class="kpi-sub" id="kpi-reach-sub">ë„ë‹¬ â€”</div><div class="kpi-tag tag-gray" id="kpi-freq">â€”</div></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-top"><div class="kpi-label">í´ë¦­ìˆ˜ / CTR</div><div class="kpi-ico" style="background:var(--yellow-light);color:var(--yellow)">ğŸ–±</div></div>
        <div class="kpi-val" id="kpi-clicks">â€”</div>
        <div class="kpi-meta"><div class="kpi-sub" id="kpi-ctr-sub">CTR â€”%</div></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-top"><div class="kpi-label">ì´ ì§€ì¶œ / CPC</div><div class="kpi-ico" style="background:var(--red-light);color:var(--red)">ğŸ’°</div></div>
        <div class="kpi-val" id="kpi-spend">â€”</div>
        <div class="kpi-meta"><div class="kpi-sub" id="kpi-cpc-sub">CPC â€”</div></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-top"><div class="kpi-label">ì „í™˜ìˆ˜ / CVR</div><div class="kpi-ico" style="background:var(--green-light);color:var(--green)">âœ…</div></div>
        <div class="kpi-val" id="kpi-conv">â€”</div>
        <div class="kpi-meta"><div class="kpi-sub" id="kpi-cvr-sub">CVR â€”%</div><div class="kpi-tag tag-gray" id="kpi-cpa-tag">CPA â€”</div></div>
      </div>
    </div>
    <div class="wide-kpi-row">
      <div class="wide-kpi">
        <div class="wide-ico" style="background:var(--purple-light);color:var(--purple)">ğŸ“ˆ</div>
        <div class="wide-content">
          <div class="wide-label">ê´‘ê³  ìˆ˜ìµë¥  (ROAS)</div>
          <div class="wide-val" id="kpi-roas">â€”</div>
          <div class="wide-sub" id="kpi-revenue-sub">ì „í™˜ ë§¤ì¶œ â€”</div>
          <div class="roas-bar-wrap"><div class="roas-bar" id="roas-bar" style="width:0%"></div></div>
        </div>
      </div>
      <div class="wide-kpi">
        <div class="wide-ico" style="background:var(--yellow-light);color:var(--yellow)">ğŸ¯</div>
        <div class="wide-content">
          <div class="wide-label">CPM / ë„ë‹¬ë‹¹ ë¹„ìš©</div>
          <div class="wide-val" id="kpi-cpm">â€”</div>
          <div class="wide-sub" id="kpi-cpreach-sub">ë„ë‹¬ë‹¹ ë¹„ìš© â€”</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Trend + Donut -->
  <div class="section-block">
    <div class="section-label">ì„±ê³¼ ì¶”ì´</div>
    <div class="charts-row">
      <div class="chart-card">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:14px">
          <div><div class="card-title">ì¼ë³„ ì„±ê³¼ íŠ¸ë Œë“œ</div><div class="card-sub">ë‚ ì§œë³„ ë°ì´í„°</div></div>
          <div class="tab-row" style="margin-bottom:0">
            <button class="tab-btn active" onclick="switchTrend('impressions',this)">ë…¸ì¶œ</button>
            <button class="tab-btn" onclick="switchTrend('clicks',this)">í´ë¦­</button>
            <button class="tab-btn" onclick="switchTrend('spend',this)">ì§€ì¶œ</button>
            <button class="tab-btn" onclick="switchTrend('ctr',this)">CTR</button>
            <button class="tab-btn" onclick="switchTrend('roas',this)">ROAS</button>
          </div>
        </div>
        <div style="position:relative;height:250px"><canvas id="trendChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="card-title">ìº í˜ì¸ë³„ ì§€ì¶œ</div>
        <div class="card-sub">ì§€ì¶œ ë¹„ì¤‘</div>
        <div style="position:relative;height:150px"><canvas id="donutChart"></canvas></div>
        <div class="legend-list" id="donut-legend"></div>
      </div>
    </div>
  </div>

  <!-- Mini Charts -->
  <div class="section-block">
    <div class="section-label">ì§€í‘œ ë¶„ì„</div>
    <div class="charts-row3">
      <div class="chart-card">
        <div class="card-title">CTR ì¶”ì´</div><div class="card-sub">Click-Through Rate</div>
        <div style="position:relative;height:150px"><canvas id="ctrChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="card-title">CPC ì¶”ì´</div><div class="card-sub">Cost Per Click</div>
        <div style="position:relative;height:150px"><canvas id="cpcChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="card-title">ROAS ì¶”ì´</div><div class="card-sub">Return on Ad Spend</div>
        <div style="position:relative;height:150px"><canvas id="roasChart"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Campaign Table -->
  <div class="section-block">
    <div class="section-label">ìº í˜ì¸ë³„ ì„±ê³¼ ë¹„êµ</div>
    <div class="table-card">
      <div class="table-header">
        <div><div class="card-title">ìº í˜ì¸ ë¸Œë ˆì´í¬ë‹¤ìš´</div><div class="card-sub">ì§€ì¶œ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ</div></div>
        <div style="font-family:var(--mono);font-size:12px;color:var(--text3)" id="camp-count"></div>
      </div>
      <div class="table-scroll"><div id="table-container"><div class="empty-state">ë°ì´í„° ë¡œë”© ì¤‘...</div></div></div>
    </div>
  </div>
</div>

<script>
/* â”€â”€ State â”€â”€ */
let TOKEN='', ACCOUNT_ID='', rawDaily=[], rawCampaigns=[], currentMetric='impressions';
const ch={};
const CONV=['offsite_conversion.fb_pixel_purchase','purchase','lead','complete_registration'];
const PAL=['#1a56db','#0e9f6e','#7e3af2','#c27803','#e02424','#60c4ff','#f7c948'];

/* â”€â”€ Format â”€â”€ */
const fmt=(n,d=0)=>{if(n==null||isNaN(n))return'â€”';n=parseFloat(n);if(n>=1e6)return(n/1e6).toFixed(1)+'M';if(n>=1e4)return(n/1e3).toFixed(1)+'K';return n.toLocaleString('ko-KR',{maximumFractionDigits:d});};
const fmtW=n=>{if(!n||isNaN(n))return'â€”';const v=parseFloat(n);if(v>=1e6)return'â‚©'+(v/1e6).toFixed(2)+'M';if(v>=1e3)return'â‚©'+(v/1e3).toFixed(0)+'K';return'â‚©'+Math.round(v).toLocaleString('ko-KR');};
const fmtPct=n=>n?parseFloat(n).toFixed(2)+'%':'0.00%';
const fmtDate=s=>{const[,m,d]=s.split('-');return`${m}/${d}`;};
const sum=(a,k)=>a.reduce((s,d)=>s+parseFloat(d[k]||0),0);
const actSum=(a,types)=>{let t=0;a.forEach(d=>(d.actions||[]).forEach(x=>{if(types.includes(x.action_type))t+=parseFloat(x.value||0);}));return t;};
const valSum=(a,types)=>{let t=0;a.forEach(d=>(d.action_values||[]).forEach(x=>{if(types.includes(x.action_type))t+=parseFloat(x.value||0);}));return t;};

const showLoading=v=>document.getElementById('loading').classList.toggle('active',v);
const toast=(msg,d=3000)=>{const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),d);};
const showError=msg=>{const e=document.getElementById('error-msg');e.style.display=msg?'block':'none';e.textContent=msg;};
const killChart=id=>{if(ch[id]){ch[id].destroy();delete ch[id];}};

function getRange(){
  const v=document.getElementById('dashboard').style.display!=='none'?document.getElementById('dash-date-preset').value:document.getElementById('date-preset').value;
  const now=new Date(),f=d=>d.toISOString().slice(0,10);
  if(v==='last_7d')return{since:f(new Date(now-6*864e5)),until:f(now)};
  if(v==='last_14d')return{since:f(new Date(now-13*864e5)),until:f(now)};
  if(v==='last_30d')return{since:f(new Date(now-29*864e5)),until:f(now)};
  if(v==='last_90d')return{since:f(new Date(now-89*864e5)),until:f(now)};
  if(v==='this_month'){const s=new Date(now.getFullYear(),now.getMonth(),1);return{since:f(s),until:f(now)};}
  if(v==='last_month'){const s=new Date(now.getFullYear(),now.getMonth()-1,1),e=new Date(now.getFullYear(),now.getMonth(),0);return{since:f(s),until:f(e)};}
  return{since:f(new Date(now-29*864e5)),until:f(now)};
}

const BASE='https://graph.facebook.com/v19.0';
async function api(path,params={}){
  const u=new URL(BASE+path);
  u.searchParams.set('access_token',TOKEN);
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,typeof v==='object'?JSON.stringify(v):v));
  const r=await fetch(u.toString());
  const d=await r.json();
  if(d.error)throw new Error(d.error.message);
  return d;
}

async function connectAPI(){
  let tok=document.getElementById('access-token').value.trim();
  let acct=document.getElementById('account-id').value.trim();
  if(!tok){showError('ì•¡ì„¸ìŠ¤ í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
  if(!acct){showError('ê´‘ê³  ê³„ì • IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
  if(!acct.startsWith('act_'))acct='act_'+acct;
  TOKEN=tok;ACCOUNT_ID=acct;showError('');showLoading(true);
  try{
    await loadAll();
    document.getElementById('setup-panel').style.display='none';
    document.getElementById('dashboard').style.display='block';
    ['refresh-btn','export-btn','logout-btn'].forEach(id=>document.getElementById(id).style.display='flex');
    document.getElementById('account-label').textContent=acct;
    document.getElementById('dash-date-preset').value=document.getElementById('date-preset').value;
    document.getElementById('last-updated').textContent='ì—…ë°ì´íŠ¸: '+new Date().toLocaleTimeString('ko-KR');
  }catch(e){showError('ì˜¤ë¥˜: '+e.message);TOKEN='';ACCOUNT_ID='';}
  finally{showLoading(false);}
}

async function refreshData(){
  if(!TOKEN)return;showLoading(true);
  try{await loadAll();document.getElementById('last-updated').textContent='ì—…ë°ì´íŠ¸: '+new Date().toLocaleTimeString('ko-KR');toast('âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ');}
  catch(e){toast('âŒ '+e.message);}finally{showLoading(false);}
}

function logout(){
  TOKEN='';ACCOUNT_ID='';
  document.getElementById('dashboard').style.display='none';
  document.getElementById('setup-panel').style.display='block';
  ['refresh-btn','export-btn','logout-btn'].forEach(id=>document.getElementById(id).style.display='none');
  document.getElementById('last-updated').textContent='';
  Object.keys(ch).forEach(killChart);
}

async function loadAll(){
  const{since,until}=getRange();
  const fields='impressions,clicks,spend,ctr,cpc,cpm,actions,action_values,reach,frequency';
  const[dr,cr]=await Promise.all([
    api(`/${ACCOUNT_ID}/insights`,{fields,time_increment:1,level:'account',time_range:{since,until}}),
    api(`/${ACCOUNT_ID}/campaigns`,{fields:`id,name,status,objective,insights.time_range({"since":"${since}","until":"${until}"}).fields(${fields})`,limit:50})
  ]);
  rawDaily=(dr.data||[]).sort((a,b)=>a.date_start.localeCompare(b.date_start));
  rawCampaigns=cr.data||[];
  const r=getRange();
  document.getElementById('date-range-label').textContent=`${r.since} ~ ${r.until}`;
  updateKPIs();renderTrend();renderDonut();renderMini();renderTable();
}

function updateKPIs(){
  const imp=sum(rawDaily,'impressions'),clicks=sum(rawDaily,'clicks'),spend=sum(rawDaily,'spend');
  const reach=sum(rawDaily,'reach'),conv=actSum(rawDaily,CONV),revenue=valSum(rawDaily,CONV);
  const ctr=imp?clicks/imp*100:0,cpc=clicks?spend/clicks:0,cpm=imp?spend/imp*1000:0;
  const cvr=clicks?conv/clicks*100:0,cpa=conv?spend/conv:0,roas=spend?revenue/spend:0;
  const freq=reach?imp/reach:0,cpreach=reach?spend/reach:0;
  document.getElementById('kpi-impressions').textContent=fmt(imp);
  document.getElementById('kpi-reach-sub').textContent='ë„ë‹¬ '+fmt(reach);
  document.getElementById('kpi-freq').textContent='ë¹ˆë„ '+freq.toFixed(1)+'x';
  document.getElementById('kpi-clicks').textContent=fmt(clicks);
  document.getElementById('kpi-ctr-sub').textContent='CTR '+ctr.toFixed(2)+'%';
  document.getElementById('kpi-spend').textContent=fmtW(spend);
  document.getElementById('kpi-cpc-sub').textContent='CPC '+fmtW(cpc);
  document.getElementById('kpi-conv').textContent=fmt(conv);
  document.getElementById('kpi-cvr-sub').textContent='CVR '+cvr.toFixed(2)+'%';
  document.getElementById('kpi-cpa-tag').textContent='CPA '+fmtW(cpa);
  document.getElementById('kpi-roas').textContent=roas>0?roas.toFixed(2)+'x':'â€”';
  document.getElementById('kpi-revenue-sub').textContent='ì „í™˜ ë§¤ì¶œ '+fmtW(revenue);
  document.getElementById('kpi-cpm').textContent=fmtW(cpm);
  document.getElementById('kpi-cpreach-sub').textContent='ë„ë‹¬ë‹¹ ë¹„ìš© '+fmtW(cpreach);
  document.getElementById('roas-bar').style.width=Math.min(roas/10*100,100)+'%';
}

const BASE_OPTS=()=>({responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:'#fff',borderColor:'#e4e7f0',borderWidth:1,titleColor:'#9ca3af',bodyColor:'#111827',titleFont:{family:'JetBrains Mono',size:11},bodyFont:{family:'JetBrains Mono',size:12},padding:12,cornerRadius:8}},scales:{x:{grid:{color:'#f3f4f6',drawBorder:false},ticks:{color:'#9ca3af',font:{family:'JetBrains Mono',size:10},maxTicksLimit:8}},y:{grid:{color:'#f3f4f6',drawBorder:false},ticks:{color:'#9ca3af',font:{family:'JetBrains Mono',size:10}}}}});

const TMETA={
  impressions:{color:'#1a56db',fmt:v=>fmt(v),tip:v=>fmt(v)},
  clicks:{color:'#c27803',fmt:v=>fmt(v),tip:v=>fmt(v)},
  spend:{color:'#e02424',fmt:v=>fmtW(v),tip:v=>fmtW(v)},
  ctr:{color:'#0e9f6e',fmt:v=>v.toFixed(2)+'%',tip:v=>v.toFixed(2)+'%'},
  roas:{color:'#7e3af2',fmt:v=>v.toFixed(2)+'x',tip:v=>v.toFixed(2)+'x'},
};

function getTrendVals(m){
  if(m==='roas')return rawDaily.map(d=>{const s=parseFloat(d.spend||0);const r=(d.action_values||[]).filter(a=>CONV.includes(a.action_type)).reduce((s,a)=>s+parseFloat(a.value||0),0);return s?r/s:0;});
  if(m==='ctr')return rawDaily.map(d=>parseFloat(d.ctr||0));
  return rawDaily.map(d=>parseFloat(d[m]||0));
}

function renderTrend(){
  killChart('trend');
  const m=TMETA[currentMetric],labels=rawDaily.map(d=>fmtDate(d.date_start)),data=getTrendVals(currentMetric);
  const ctx=document.getElementById('trendChart').getContext('2d');
  const g=ctx.createLinearGradient(0,0,0,260);g.addColorStop(0,m.color+'22');g.addColorStop(1,'transparent');
  const o=BASE_OPTS();o.scales.y.ticks.callback=m.fmt;o.plugins.tooltip.callbacks={label:c=>' '+m.tip(c.raw)};
  ch.trend=new Chart(ctx,{type:'line',data:{labels,datasets:[{data,borderColor:m.color,backgroundColor:g,borderWidth:2.5,pointRadius:2.5,pointHoverRadius:5,tension:0.4,fill:true}]},options:o});
}

function switchTrend(metric,btn){
  currentMetric=metric;
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderTrend();
}

function renderDonut(){
  killChart('donut');
  const top=rawCampaigns.map(c=>({name:c.name,spend:parseFloat(c.insights?.data?.[0]?.spend||0)})).sort((a,b)=>b.spend-a.spend).slice(0,6);
  const total=top.reduce((s,c)=>s+c.spend,0);
  const ctx=document.getElementById('donutChart').getContext('2d');
  ch.donut=new Chart(ctx,{type:'doughnut',data:{labels:top.map(c=>c.name),datasets:[{data:top.map(c=>c.spend),backgroundColor:PAL,borderWidth:2,borderColor:'#fff',hoverOffset:4}]},options:{responsive:true,maintainAspectRatio:false,cutout:'72%',plugins:{legend:{display:false},tooltip:{backgroundColor:'#fff',borderColor:'#e4e7f0',borderWidth:1,titleFont:{family:'JetBrains Mono',size:11},bodyFont:{family:'JetBrains Mono',size:12},callbacks:{label:c=>' '+fmtW(c.raw)}}}}});
  document.getElementById('donut-legend').innerHTML=top.map((c,i)=>`<div class="legend-row"><div class="legend-color" style="background:${PAL[i]}"></div><span class="legend-name" title="${c.name}">${c.name}</span><span class="legend-amt">${fmtW(c.spend)}</span><span class="legend-pct">${total?(c.spend/total*100).toFixed(0)+'%':'0%'}</span></div>`).join('');
}

function renderMini(){
  const labels=rawDaily.map(d=>fmtDate(d.date_start));
  // CTR
  killChart('ctr');
  const co=BASE_OPTS();co.scales.y.ticks.callback=v=>v.toFixed(2)+'%';co.plugins.tooltip.callbacks={label:c=>' '+c.raw.toFixed(2)+'%'};
  ch.ctr=new Chart(document.getElementById('ctrChart'),{type:'bar',data:{labels,datasets:[{data:rawDaily.map(d=>parseFloat(d.ctr||0)),backgroundColor:'rgba(194,120,3,0.15)',borderColor:'#c27803',borderWidth:1.5,borderRadius:3}]},options:co});
  // CPC
  killChart('cpc');
  const cpo=BASE_OPTS();cpo.scales.y.ticks.callback=v=>'â‚©'+Math.round(v).toLocaleString('ko-KR');cpo.plugins.tooltip.callbacks={label:c=>' '+fmtW(c.raw)};
  const cpcCtx=document.getElementById('cpcChart').getContext('2d');const cg=cpcCtx.createLinearGradient(0,0,0,150);cg.addColorStop(0,'rgba(224,36,36,0.1)');cg.addColorStop(1,'transparent');
  ch.cpc=new Chart(cpcCtx,{type:'line',data:{labels,datasets:[{data:rawDaily.map(d=>parseFloat(d.cpc||0)),borderColor:'#e02424',backgroundColor:cg,borderWidth:2,pointRadius:2,tension:0.4,fill:true}]},options:cpo});
  // ROAS
  killChart('roas');
  const ro=BASE_OPTS();ro.scales.y.ticks.callback=v=>v.toFixed(1)+'x';ro.plugins.tooltip.callbacks={label:c=>' '+c.raw.toFixed(2)+'x'};
  const rCtx=document.getElementById('roasChart').getContext('2d');const rg=rCtx.createLinearGradient(0,0,0,150);rg.addColorStop(0,'rgba(126,58,242,0.1)');rg.addColorStop(1,'transparent');
  const rData=rawDaily.map(d=>{const s=parseFloat(d.spend||0);const r=(d.action_values||[]).filter(a=>CONV.includes(a.action_type)).reduce((s,a)=>s+parseFloat(a.value||0),0);return s?r/s:0;});
  ch.roas=new Chart(rCtx,{type:'line',data:{labels,datasets:[{data:rData,borderColor:'#7e3af2',backgroundColor:rg,borderWidth:2,pointRadius:2,tension:0.4,fill:true}]},options:ro});
}

function renderTable(){
  const box=document.getElementById('table-container');
  const data=rawCampaigns.filter(c=>c.insights?.data?.[0]).sort((a,b)=>parseFloat(b.insights.data[0].spend||0)-parseFloat(a.insights.data[0].spend||0));
  document.getElementById('camp-count').textContent=data.length+'ê°œ ìº í˜ì¸';
  if(!data.length){box.innerHTML='<div class="empty-state">ìº í˜ì¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';return;}
  const maxSpend=Math.max(...data.map(c=>parseFloat(c.insights.data[0].spend||0)));
  box.innerHTML=`<table><thead><tr>
    <th>ìº í˜ì¸ëª…</th><th>ìƒíƒœ</th><th class="r">ë…¸ì¶œìˆ˜</th><th class="r">í´ë¦­ìˆ˜</th><th class="r">CTR</th>
    <th class="r">ì§€ì¶œ</th><th class="r">CPC</th><th class="r">CPM</th><th class="r">ì „í™˜ìˆ˜</th><th class="r">CVR</th><th class="r">CPA</th><th class="r">ROAS</th>
  </tr></thead><tbody>
  ${data.map(c=>{
    const ins=c.insights.data[0];
    const conv=(ins.actions||[]).filter(a=>CONV.includes(a.action_type)).reduce((s,a)=>s+parseFloat(a.value||0),0);
    const revenue=(ins.action_values||[]).filter(a=>CONV.includes(a.action_type)).reduce((s,a)=>s+parseFloat(a.value||0),0);
    const spend=parseFloat(ins.spend||0),clicks=parseFloat(ins.clicks||0);
    const cvr=clicks?conv/clicks*100:0,cpa=conv?spend/conv:0,roas=spend?revenue/spend:0;
    const sCls=c.status==='ACTIVE'?'s-active':c.status==='PAUSED'?'s-paused':'s-other';
    const sLbl=c.status==='ACTIVE'?'í™œì„±':c.status==='PAUSED'?'ì¼ì‹œì •ì§€':c.status||'â€”';
    const rCls=roas>=3?'rg':roas>=1?'rb':'rl';
    const bp=maxSpend?Math.round(spend/maxSpend*100):0;
    return`<tr>
      <td><div class="c-name" title="${c.name}">${c.name}</div><div class="c-obj">${c.objective||''}</div></td>
      <td><span class="s-badge ${sCls}">${sLbl}</span></td>
      <td class="td-r">${fmt(parseFloat(ins.impressions||0))}</td>
      <td class="td-r">${fmt(clicks)}</td>
      <td class="td-r">${fmtPct(ins.ctr)}</td>
      <td class="td-rh">${fmtW(spend)}<div class="bar-wrap"><div class="bar-fill" style="width:${bp}%"></div></div></td>
      <td class="td-r">${fmtW(ins.cpc)}</td>
      <td class="td-r">${fmtW(ins.cpm)}</td>
      <td class="td-r">${conv>0?fmt(conv):'â€”'}</td>
      <td class="td-r">${cvr>0?cvr.toFixed(2)+'%':'â€”'}</td>
      <td class="td-r">${cpa>0?fmtW(cpa):'â€”'}</td>
      <td><span class="roas-pill ${rCls}">${roas>0?roas.toFixed(2)+'x':'â€”'}</span></td>
    </tr>`;
  }).join('')}
  </tbody></table>`;
}

function exportCSV(){
  const data=rawCampaigns.filter(c=>c.insights?.data?.[0]).sort((a,b)=>parseFloat(b.insights.data[0].spend||0)-parseFloat(a.insights.data[0].spend||0));
  if(!data.length){toast('âš ï¸ ë°ì´í„° ì—†ìŒ');return;}
  const rows=[['ìº í˜ì¸ëª…','ìƒíƒœ','ë…¸ì¶œìˆ˜','í´ë¦­ìˆ˜','CTR(%)','ì§€ì¶œ','CPC','CPM','ì „í™˜ìˆ˜','CVR(%)','CPA','ROAS']];
  data.forEach(c=>{
    const ins=c.insights.data[0];
    const conv=(ins.actions||[]).filter(a=>CONV.includes(a.action_type)).reduce((s,a)=>s+parseFloat(a.value||0),0);
    const revenue=(ins.action_values||[]).filter(a=>CONV.includes(a.action_type)).reduce((s,a)=>s+parseFloat(a.value||0),0);
    const spend=parseFloat(ins.spend||0),clicks=parseFloat(ins.clicks||0);
    rows.push([c.name,c.status,ins.impressions||0,ins.clicks||0,parseFloat(ins.ctr||0).toFixed(2),spend.toFixed(0),parseFloat(ins.cpc||0).toFixed(0),parseFloat(ins.cpm||0).toFixed(0),conv,clicks?(conv/clicks*100).toFixed(2):'0',conv?spend/conv:0,spend?revenue/spend:0]);
  });
  const csv=rows.map(r=>r.map(v=>`"${v}"`).join(',')).join('\n');
  const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,\uFEFF'+encodeURIComponent(csv);a.download=`meta_ads_${new Date().toISOString().slice(0,10)}.csv`;a.click();toast('âœ… CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
}

document.addEventListener('keydown',e=>{if(e.key==='Enter'&&document.getElementById('setup-panel').style.display!=='none')connectAPI();});
</script>
</body>
</html>
